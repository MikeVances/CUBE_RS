# Sensor Status Redesign — CUBE_RS

Цель: показывать только нужную информацию и корректно трактовать спец‑коды датчиков. Исключить ложные тревоги и задержки в UI/боте при восстановлении датчиков.

## Что сделано

- Добавлены текстовые статусы сенсоров в слой сбора данных и БД:
  - `pressure_status`, `humidity_status`, `co2_status`, `nh3_status` со значениями: `ok | pending | break | error | disabled`.
  - Миграция БД: колонки добавляются автоматически при запуске.

- Reader (`modbus/reader.py`):
  - Читает сырое значение регистра и вычисляет статус по спец‑кодам (например, для 0x0083: 0xFFFF — pending, 0xFFFE — break, 0xFFFD — error, 0xFFFC — disabled). Аналогичная логика применена к 0x0084/0x0085/0x0086.
  - Записывает числовые значения только при `ok`; иначе значение становится `NULL` (None), а причину хранит статус.
  - Активные аварии читаются как полный 64‑битный битфилд из 0x00C0–0x00C3.

- БД (`modbus/modbus_storage.py`):
  - `latest_data` и `sensor_data` расширены полями `*_status`.
  - `init_db()` самостоятельно добавляет недостающие колонки через `ALTER TABLE`.

- Telegram‑бот:
  - В “Показаниях” скрывает отключённые датчики (`*_status=disabled`), для `pending` выводит “ожидаем замер”.
  - Логика “Система в норме” игнорирует отключённые/ожидающие датчики.
  - Уже поддерживает отображение аварийного реле.
  - Понимает восстановление датчиков (история за 15 минут) и предлагает сброс аварий при активном реле/флагах.

- Dashboard (Streamlit):
  - Не сглаживает дискретные поля (active_alarms, DO*, alarm_relay и пр.).
  - Карточки учитывают `*_status`: скрывают/серые подписи для `disabled/pending`.
  - Порог CO₂ приведён к норме 400–3000 ppm.
  - Показывает “Реле аварии: ВКЛ/ВЫКЛ”.

## Почему это важно

- Исключаем ложные тревоги по отключённым сенсорам.
- Убираем “пилу” значений и задержки от сглаживания дискретных сигналов.
- Улучшаем UX операторов: ясные статусы, подсказки к сбросу при восстановлении датчиков.

## Что требуется от команды

- Подтвердить спец‑коды для 0x0084 (влажность), 0x0085 (CO₂), 0x0086 (NH₃). Сейчас применены правила по аналогии с 0x0083.
- Уточнить карту битов “реле аварии” и подтвердить значения в `config/app_config.yaml` (по умолчанию `0x0082`, бит 7).

## Технические детали

- Файлы:
  - БД и сбор: `modbus/modbus_storage.py`, `modbus/reader.py`.
  - Бот: `telegram_bot/bot_utils.py`, `telegram_bot/bot_main.py`.
  - Дашборд: `dashboard/app.py`, `dashboard/dashboard_reader.py`.
  - Конфиг реле: `config/app_config.yaml` (`alarm_relay`).

- Статусы вычисляются на этапе чтения регистров, сохраняются в БД и используются во всех UI слоях.

## Затем

- При появлении полной карты битов 0x00C3/0x00CB — расширить декодер аварий и показывать имена событий.
- (Опционально) Добавить авто‑refresh аварий/реле после успешной записи (write) для уменьшения латентности.

