<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>üì° –î–∞–Ω–Ω—ã–µ –æ—Ç –ö–£–ë-1063</title>
  <style>
    body { font-family: sans-serif; background: #1e1e1e; color: #dcdcdc; text-align: center; padding: 2em; }
    .data-block { font-size: 2em; margin-top: 1em; }
    .label { color: #8abeb7; }
    .value { font-weight: bold; }
    .error { color: #cc6666; }
  </style>
</head>
<body>
  <h1>üìü CUBE RS WebSocket</h1>
  <div id="status">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</div>
  <div class="data-block" id="temperature"></div>
  <div class="data-block" id="humidity"></div>
  <div class="data-block" id="co2"></div>
  <div class="data-block" id="updated_at"></div>

  <script>
    const ws = new WebSocket("ws://localhost:8765");

    ws.onopen = () => {
      document.getElementById("status").textContent = "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ";
      ws.send(JSON.stringify({ cmd: "get" }));
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
      setInterval(() => {
        if (ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ cmd: "get" }));
        }
      }, 5000);
    };

    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        document.getElementById("temperature").innerHTML = `<span class="label">üå° –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:</span> <span class="value">${data.temp_inside ?? '‚Äî'} ¬∞C</span>`;
        // –ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞: —Å—á–µ—Ç—á–∏–∫ –¥–Ω–µ–π
        let dayCounterHtml = '';
        if (data.day_counter !== undefined && data.day_counter !== null) {
          dayCounterHtml = `<div class="data-block"><span class="label">üìÖ –°—á–µ—Ç—á–∏–∫ –¥–Ω–µ–π:</span> <span class="value">${data.day_counter}</span></div>`;
        }
        document.getElementById("temperature").innerHTML += dayCounterHtml;
        document.getElementById("humidity").innerHTML = `<span class="label">üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å:</span> <span class="value">${data.humidity ?? '‚Äî'} %</span>`;
        document.getElementById("co2").innerHTML = `<span class="label">üå¨ CO‚ÇÇ:</span> <span class="value">${data.co2 ?? '‚Äî'} ppm</span>`;
        if (data.updated_at) {
          const updated = new Date(data.updated_at);
          const now = new Date();
          const diffMs = now - updated;
          const diffMinutes = Math.floor(diffMs / 60000);
          const diffSeconds = Math.floor((diffMs % 60000) / 1000);
          
          let timeText;
          if (diffMinutes < 1) {
            timeText = `${diffSeconds} —Å–µ–∫ –Ω–∞–∑–∞–¥`;
          } else if (diffMinutes < 60) {
            timeText = `${diffMinutes} –º–∏–Ω –Ω–∞–∑–∞–¥`;
          } else {
            const diffHours = Math.floor(diffMinutes / 60);
            timeText = `${diffHours} —á –Ω–∞–∑–∞–¥`;
          }
          
          document.getElementById("updated_at").innerHTML = `<span class="label">üïí –û–±–Ω–æ–≤–ª–µ–Ω–æ:</span> <span class="value">${timeText}</span>`;
        }
      } catch (err) {
        document.getElementById("status").innerHTML = `<span class="error">‚ùå –û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö</span>`;
      }
    };

    ws.onerror = () => {
      document.getElementById("status").innerHTML = `<span class="error">‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</span>`;
    };

    ws.onclose = () => {
      document.getElementById("status").innerHTML = `<span class="error">üîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ</span>`;
    };
  </script>
</body>
</html>