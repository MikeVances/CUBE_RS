
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–£–ë-1063 Mobile - –ú–æ–∏ —Ñ–µ—Ä–º—ã</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); margin-bottom: 1rem; }
        .farm-card { cursor: pointer; transition: transform 0.2s; }
        .farm-card:hover { transform: translateY(-2px); }
        .status-online { color: #28a745; }
        .status-offline { color: #dc3545; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <span class="navbar-brand">üè≠ –ö–£–ë-1063 Mobile</span>
            <a href="/logout" class="btn btn-outline-light btn-sm">–í—ã–π—Ç–∏</a>
        </div>
    </nav>
    
    <div class="container py-4">
        <div id="farmsContainer">
            <div class="text-center py-5">
                <div class="spinner-border" role="status"></div>
                <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–µ—Ä–º...</p>
            </div>
        </div>
        
        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–∞–Ω–Ω—ã–º–∏ —Ñ–µ—Ä–º—ã -->
        <div class="modal fade" id="farmModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="farmModalTitle">–î–∞–Ω–Ω—ã–µ —Ñ–µ—Ä–º—ã</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="farmModalBody">
                        <!-- –î–∞–Ω–Ω—ã–µ —Ñ–µ—Ä–º—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let farms = [];
        let currentFarmId = null;
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ñ–µ—Ä–º
        async function loadFarms() {
            try {
                const response = await fetch('/api/farms');
                const data = await response.json();
                
                if (data.status === 'success') {
                    farms = data.farms;
                    displayFarms();
                } else {
                    document.getElementById('farmsContainer').innerHTML = 
                        '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–µ—Ä–º</div>';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('farmsContainer').innerHTML = 
                    '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>';
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–µ—Ä–º
        function displayFarms() {
            const container = document.getElementById('farmsContainer');
            
            if (farms.length === 0) {
                container.innerHTML = '<div class="alert alert-info">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Ñ–µ—Ä–º</div>';
                return;
            }
            
            let html = '<div class="row">';
            
            farms.forEach(farm => {
                const isOnline = Date.now() / 1000 - farm.last_seen < 600; // 10 –º–∏–Ω—É—Ç
                const statusClass = isOnline ? 'status-online' : 'status-offline';
                const statusText = isOnline ? '–û–Ω–ª–∞–π–Ω' : '–û—Ñ–ª–∞–π–Ω';
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card farm-card" onclick="connectToFarm('${farm.farm_id}')">
                            <div class="card-body">
                                <h5 class="card-title">${farm.farm_name}</h5>
                                <p class="card-text text-muted">ID: ${farm.farm_id}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="${statusClass}">‚óè ${statusText}</small>
                                    <small class="text-muted">${new Date(farm.last_seen * 1000).toLocaleString('ru-RU')}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ñ–µ—Ä–º–µ
        async function connectToFarm(farmId) {
            const farm = farms.find(f => f.farm_id === farmId);
            if (!farm) return;
            
            currentFarmId = farmId;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –∑–∞–≥—Ä—É–∑–∫–∏
            document.getElementById('farmModalTitle').textContent = farm.farm_name;
            document.getElementById('farmModalBody').innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border" role="status"></div>
                    <p class="mt-2">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ñ–µ—Ä–º–µ...</p>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('farmModal'));
            modal.show();
            
            try {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                const connectResponse = await fetch(`/api/connect/${farmId}`, {
                    method: 'POST'
                });
                
                const connectResult = await connectResponse.json();
                
                if (connectResult.status === 'success') {
                    // –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                    await loadFarmData(farmId);
                } else {
                    document.getElementById('farmModalBody').innerHTML = `
                        <div class="alert alert-danger">
                            ${connectResult.message || '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Ñ–µ—Ä–º–µ'}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
                document.getElementById('farmModalBody').innerHTML = `
                    <div class="alert alert-danger">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Ñ–µ—Ä–º–µ</div>
                `;
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ñ–µ—Ä–º—ã
        async function loadFarmData(farmId) {
            try {
                const response = await fetch(`/api/farm/${farmId}/data`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    displayFarmData(data.data);
                } else {
                    document.getElementById('farmModalBody').innerHTML = `
                        <div class="alert alert-warning">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç —Ñ–µ—Ä–º—ã</div>
                    `;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                document.getElementById('farmModalBody').innerHTML = `
                    <div class="alert alert-danger">–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö</div>
                `;
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ñ–µ—Ä–º—ã
        function displayFarmData(data) {
            const html = `
                <div class="row">
                    <div class="col-6 text-center">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h3 class="text-primary">${data.temp_inside}¬∞C</h3>
                                <small class="text-muted">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 text-center">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h3 class="text-info">${data.humidity}%</h3>
                                <small class="text-muted">–í–ª–∞–∂–Ω–æ—Å—Ç—å</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 text-center mt-2">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h3 class="text-warning">${data.co2}</h3>
                                <small class="text-muted">CO‚ÇÇ (ppm)</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 text-center mt-2">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h3 class="text-success">–û–Ω–ª–∞–π–Ω</h3>
                                <small class="text-muted">–°—Ç–∞—Ç—É—Å</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${new Date(data.timestamp * 1000).toLocaleString('ru-RU')}
                    </small>
                </div>
            `;
            
            document.getElementById('farmModalBody').innerHTML = html;
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–µ—Ä–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', loadFarms);
    </script>
</body>
</html>
