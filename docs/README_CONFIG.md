# üîß –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ö–£–ë-1063

## üìã –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

–°–∏—Å—Ç–µ–º–∞ –ö–£–ë-1063 —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥-–º–µ–Ω–µ–¥–∂–µ—Ä** –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏. –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã:

- ‚ùå **–†–∞–∑–±—Ä–æ—Å–∞–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** –ø–æ —Ä–∞–∑–Ω—ã–º —Ñ–∞–π–ª–∞–º
- ‚ùå **–•–∞—Ä–¥–∫–æ–¥ –ø–æ—Ä—Ç–æ–≤** –≤ –∫–æ–¥–µ  
- ‚ùå **–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π**
- ‚ùå **–°–ª–æ–∂–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** –Ω–æ–≤—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```
config/
‚îú‚îÄ‚îÄ app_config.yaml          # ‚úÖ –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã
‚îú‚îÄ‚îÄ bot_secrets.json         # üîê –¢–æ–∫–µ–Ω—ã –∏ —Å–µ–∫—Ä–µ—Ç—ã (–ù–ï –≤ git!)
‚îî‚îÄ‚îÄ logs/                    # üìù –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏

core/
‚îî‚îÄ‚îÄ config_manager.py        # üéØ –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```

## ‚öôÔ∏è –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### `config/app_config.yaml`

```yaml
# –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã
system:
  environment: development    # development, production, testing  
  log_level: INFO
  startup_timeout: 60

# RS485 –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ö–£–ë-1063
rs485:
  port: /dev/tty.usbserial-21230
  baudrate: 9600
  timeout: 2.0
  slave_id: 1

# Modbus TCP —Å–µ—Ä–≤–µ—Ä  
modbus_tcp:
  port: 5023                 # üéØ –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ—Ä—Ç –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã!
  timeout: 3.0

# –í–∫–ª—é—á–µ–Ω–∏–µ/–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤  
services:
  gateway_enabled: true      # üéõÔ∏è –ü—Ä–æ—Å—Ç–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞–º–∏
  dashboard_enabled: true
  telegram_enabled: true
  websocket_enabled: false
  
  dashboard_port: 8501
  websocket_port: 8765

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
database:
  file: kub_data.db
  commands_db: kub_commands.db
  timeout: 5

# –í—Å–µ Modbus —Ä–µ–≥–∏—Å—Ç—Ä—ã –ö–£–ë-1063
modbus_registers:
  software_version: "0x0301"
  pressure: "0x0083"
  humidity: "0x0084"
  # ... –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ
```

### `config/bot_secrets.json` 

```json
{
  "telegram": {
    "bot_token": "YOUR_BOT_TOKEN",
    "admin_users": [123456789]
  }
}
```

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ConfigManager

### –í –∫–æ–¥–µ Python

```python
from core.config_manager import get_config

# –ü–æ–ª—É—á–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥
config = get_config()

# –ß–∏—Ç–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
port = config.modbus_tcp.port              # 5023
rs485_port = config.rs485.port             # /dev/tty.usbserial-21230  
token = config.telegram.token              # Bot token
admins = config.telegram.admin_users       # [123456789]

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∫–ª—é—á–µ–Ω –ª–∏ —Å–µ—Ä–≤–∏—Å
if config.services.gateway_enabled:
    start_gateway()
```

### Shortcuts –¥–ª—è —á–∞—Å—Ç—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫

```python
from core.config_manager import (
    get_gateway_port,
    get_telegram_token, 
    get_rs485_port
)

port = get_gateway_port()       # 5023
token = get_telegram_token()    # Bot token
```

## üîÑ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

ConfigManager –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```bash
export TELEGRAM_BOT_TOKEN="your_token"
export RS485_PORT="/dev/ttyUSB0"  
export ENVIRONMENT="production"
export LOG_LEVEL="WARNING"
```

## üìä –£—Ä–æ–≤–Ω–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞

1. **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è** (–≤—ã—Å—à–∏–π)
2. **config/app_config.yaml** 
3. **config/bot_secrets.json**
4. **–ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é** (–Ω–∏–∑—à–∏–π)

## üõ†Ô∏è –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã

### –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã —Å—Ä–∞–∑—É

```bash
python tools/start_all_services.py
```

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç —Ç–æ–ª—å–∫–æ **–≤–∫–ª—é—á–µ–Ω–Ω—ã–µ –≤ –∫–æ–Ω—Ñ–∏–≥–µ** —Å–µ—Ä–≤–∏—Å—ã:

- ‚úÖ Gateway (–µ—Å–ª–∏ `gateway_enabled: true`)
- ‚úÖ Dashboard (–µ—Å–ª–∏ `dashboard_enabled: true`) 
- ‚úÖ Telegram Bot (–µ—Å–ª–∏ `telegram_enabled: true`)
- ‚ùå WebSocket (–µ—Å–ª–∏ `websocket_enabled: false`)

### –û—Ç–¥–µ–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã

```bash
# Gateway —Å –∞–≤—Ç–æ–Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π –ø–æ—Ä—Ç–æ–≤
python -m modbus.gateway

# Telegram Bot —Å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π  
python telegram_bot/run_bot.py

# Dashboard –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω–æ–º –ø–æ—Ä—Ç—É
streamlit run dashboard/app.py --server.port 8501
```

## ‚ú® –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

### üéØ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è
- **–û–¥–Ω–æ –º–µ—Å—Ç–æ** –¥–ª—è –≤—Å–µ—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
- **–ù–µ—Ç —Ö–∞—Ä–¥–∫–æ–¥–∞** –≤ –∫–æ–¥–µ  
- **–ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç** –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### üîß –ü—Ä–æ—Å—Ç–æ—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- –ú–µ–Ω—è–µ—Ç–µ –ø–æ—Ä—Ç –≤ **–æ–¥–Ω–æ–º –º–µ—Å—Ç–µ** ‚Üí —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–µ–∑–¥–µ
- **–í–∫–ª—é—á–∏–ª/–≤—ã–∫–ª—é—á–∏–ª —Å–µ—Ä–≤–∏—Å** –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π
- **Environment-based** –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### üöÄ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å  
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å **–Ω–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏**
- **–í–∞–ª–∏–¥–∞—Ü–∏—è** –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
- **Hot reload** –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–∏—Å—Ç–µ–º—ã

### üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- **–°–µ–∫—Ä–µ—Ç—ã –æ—Ç–¥–µ–ª—å–Ω–æ** –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞
- **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è** –¥–ª—è production
- **–ù–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ git** (bot_secrets.json)

## üîç –û—Ç–ª–∞–¥–∫–∞ –∏ –ª–æ–≥–∏

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–æ–≥–æ–≤

```
logs/
‚îú‚îÄ‚îÄ gateway1.log          # Modbus TCP Gateway
‚îú‚îÄ‚îÄ telegram.log          # Telegram Bot  
‚îú‚îÄ‚îÄ dashboard.log         # Streamlit Dashboard
‚îú‚îÄ‚îÄ start_services.log    # –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–µ—Ä–≤–∏—Å–æ–≤
‚îî‚îÄ‚îÄ system.log            # –û–±—â–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```bash
# –¢–µ—Å—Ç ConfigManager
python core/config_manager.py

# –í—ã–≤–æ–¥: 
üîß –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ConfigManager...
üì° RS485 –ø–æ—Ä—Ç: /dev/tty.usbserial-21230  
üåê Gateway 1 –ø–æ—Ä—Ç: 5023
üíæ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: kub_data.db
ü§ñ Telegram –∞–¥–º–∏–Ω—ã: 1
‚úÖ ConfigManager –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ!
```

## üö® –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### "–ü–æ—Ä—Ç —É–∂–µ –∑–∞–Ω—è—Ç"
```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∫–∏–µ –ø–æ—Ä—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
python -c "from core.config_manager import get_config; c=get_config(); print(f'–ü–æ—Ä—Ç—ã: {c.modbus_tcp.port}, {c.services.dashboard_port}')"

# –ú–µ–Ω—è–µ–º –≤ config/app_config.yaml:
modbus_tcp:
  port: 5024  # –ù–æ–≤—ã–π —Å–≤–æ–±–æ–¥–Ω—ã–π –ø–æ—Ä—Ç
```

### "–ù–µ –Ω–∞–π–¥–µ–Ω —Ç–æ–∫–µ–Ω –±–æ—Ç–∞"
```bash
# –°–æ–∑–¥–∞—ë–º config/bot_secrets.json:
echo '{"telegram": {"bot_token": "YOUR_TOKEN", "admin_users": [YOUR_ID]}}' > config/bot_secrets.json

# –ò–ª–∏ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è:
export TELEGRAM_BOT_TOKEN="your_token"
```

### "–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ ConfigManager"
```bash
pip install PyYAML>=6.0.1
```

## üéâ –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ —Å—Ç–∞—Ä–æ–π —Å–∏—Å—Ç–µ–º—ã

–°—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã **—É–¥–∞–ª–µ–Ω—ã**:
- ‚ùå `config.json` 
- ‚ùå `telegram_bot/bot_config.json`
- ‚ùå –•–∞—Ä–¥–∫–æ–¥ –ø–æ—Ä—Ç–æ–≤ –≤ –∫–æ–¥–µ

–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–ø–µ—Ä—å –≤ `config/app_config.yaml` + `config/bot_secrets.json`.

---

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é –∏ –ø—Ä–æ—Å—Ç–æ–º—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é! üöÄ**