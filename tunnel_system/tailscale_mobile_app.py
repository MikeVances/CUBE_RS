#!/usr/bin/env python3
"""
Tailscale Mobile App - –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–µ—Ä–º–∞–º —á–µ—Ä–µ–∑ Tailscale mesh-—Å–µ—Ç—å
–ó–∞–º–µ–Ω—è–µ—Ç WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–∞ –ø—Ä—è–º—ã–µ HTTP –∑–∞–ø—Ä–æ—Å—ã –∫ —Ñ–µ—Ä–º–∞–º
"""

import os
import json
import time
import asyncio
import logging
import aiohttp
from typing import Dict, List, Any, Optional
from flask import Flask, render_template, request, jsonify, session, redirect, url_for
from flask_cors import CORS

from tailscale_manager import TailscaleManager

logger = logging.getLogger(__name__)

class TailscaleFarmConnector:
    """–ö–æ–Ω–Ω–µ–∫—Ç–æ—Ä –¥–ª—è –ø—Ä—è–º–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Ñ–µ—Ä–º–∞–º —á–µ—Ä–µ–∑ Tailscale"""
    
    def __init__(self):
        self.active_connections = {}  # farm_ip -> connection_info
        self.connection_timeout = aiohttp.ClientTimeout(total=10)
    
    async def test_farm_connection(self, farm_ip: str, port: int = 8080) -> bool:
        """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Ñ–µ—Ä–º–æ–π"""
        try:
            url = f"http://{farm_ip}:{port}/health"
            async with aiohttp.ClientSession(timeout=self.connection_timeout) as session:
                async with session.get(url) as response:
                    if response.status == 200:
                        data = await response.json()
                        logger.debug(f"–§–µ—Ä–º–∞ {farm_ip} –¥–æ—Å—Ç—É–ø–Ω–∞: {data.get('status')}")
                        return True
                    else:
                        logger.warning(f"–§–µ—Ä–º–∞ {farm_ip} –≤–µ—Ä–Ω—É–ª–∞ —Å—Ç–∞—Ç—É—Å {response.status}")
                        return False
                        
        except asyncio.TimeoutError:
            logger.warning(f"Timeout –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Ñ–µ—Ä–º–µ {farm_ip}")
            return False
        except Exception as e:
            logger.debug(f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Ñ–µ—Ä–º–µ {farm_ip}: {e}")
            return False
    
    async def send_farm_request(self, farm_ip: str, endpoint: str, 
                               method: str = 'GET', data: Dict = None,
                               port: int = 8080) -> Dict[str, Any]:
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ —Ñ–µ—Ä–º–µ —á–µ—Ä–µ–∑ Tailscale"""
        try:
            url = f"http://{farm_ip}:{port}{endpoint}"
            
            async with aiohttp.ClientSession(timeout=self.connection_timeout) as session:
                if method.upper() == 'GET':
                    async with session.get(url) as response:
                        result = await response.json()
                        result['_connection_status'] = 'success'
                        result['_response_time'] = time.time()
                        return result
                        
                elif method.upper() == 'POST':
                    async with session.post(url, json=data) as response:
                        result = await response.json()
                        result['_connection_status'] = 'success'
                        result['_response_time'] = time.time()
                        return result
                        
        except asyncio.TimeoutError:
            return {
                '_connection_status': 'timeout',
                'error': f'Timeout –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Ñ–µ—Ä–º–µ {farm_ip}'
            }
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ —Ñ–µ—Ä–º–µ {farm_ip}: {e}")
            return {
                '_connection_status': 'error',
                'error': str(e)
            }
    
    async def get_farm_current_data(self, farm_ip: str, port: int = 8080) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö —Ñ–µ—Ä–º—ã"""
        return await self.send_farm_request(farm_ip, '/api/data/current', port=port)
    
    async def get_farm_history_data(self, farm_ip: str, hours: int = 24, port: int = 8080) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö —Ñ–µ—Ä–º—ã"""
        endpoint = f'/api/data/history?hours={hours}'
        return await self.send_farm_request(farm_ip, endpoint, port=port)
    
    async def get_farm_statistics(self, farm_ip: str, port: int = 8080) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ñ–µ—Ä–º—ã"""
        return await self.send_farm_request(farm_ip, '/api/data/statistics', port=port)
    
    async def send_farm_command(self, farm_ip: str, command: str, params: Dict = None, port: int = 8080) -> Dict[str, Any]:
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã —Ñ–µ—Ä–º–µ"""
        data = {'command': command}
        if params:
            data.update(params)
        return await self.send_farm_request(farm_ip, '/api/commands', 'POST', data, port=port)

class TailscaleMobileApp:
    """–ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–µ—Ä–º–∞–º–∏ —á–µ—Ä–µ–∑ Tailscale"""
    
    def __init__(self, discovery_service_url: str, tailscale_config: Dict[str, Any]):
        self.discovery_url = discovery_service_url.rstrip('/')
        self.tailscale_config = tailscale_config
        
        # Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        self.app = Flask(__name__)
        self.app.secret_key = os.getenv('SECRET_KEY', 'tailscale-mobile-app-secret-key')
        CORS(self.app)
        
        # –ö–æ–Ω–Ω–µ–∫—Ç–æ—Ä –¥–ª—è —Ñ–µ—Ä–º
        self.farm_connector = TailscaleFarmConnector()
        self.tailscale_manager = None
        
        # –ö—ç—à –¥–∞–Ω–Ω—ã—Ö
        self.farms_cache = {}
        self.cache_expiry = 300  # 5 –º–∏–Ω—É—Ç
        self.last_cache_update = 0
        
        self.setup_routes()
    
    def setup_routes(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤ Flask"""
        
        @self.app.route('/')
        def index():
            """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"""
            if 'user_id' not in session:
                return redirect(url_for('login'))
            return render_template('tailscale_mobile_index.html')
        
        @self.app.route('/login')
        def login():
            """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞"""
            return render_template('tailscale_mobile_login.html')
        
        @self.app.route('/api/login', methods=['POST'])
        def api_login():
            """API –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)"""
            try:
                data = request.get_json()
                username = data.get('username')\n                password = data.get('password')\n                \n                # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –Ω—É–∂–Ω–∞ –ø–æ–ª–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è)\n                if username and password:\n                    session['user_id'] = f'user_{username}'\n                    session['username'] = username\n                    logger.info(f\"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {username} –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω\")\n                    \n                    return jsonify({\n                        'status': 'success',\n                        'message': '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞',\n                        'user_id': session['user_id']\n                    })\n                else:\n                    return jsonify({\n                        'status': 'error',\n                        'message': '–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'\n                    }), 401\n                    \n            except Exception as e:\n                logger.error(f\"–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: {e}\")\n                return jsonify({\n                    'status': 'error',\n                    'message': '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'\n                }), 500\n        \n        @self.app.route('/api/logout', methods=['POST'])\n        def api_logout():\n            \"\"\"API –≤—ã—Ö–æ–¥–∞\"\"\"\n            session.clear()\n            return jsonify({'status': 'success', 'message': '–í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω'})\n        \n        @self.app.route('/api/farms')\n        def api_get_farms():\n            \"\"\"–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–µ—Ä–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\"\"\"\n            if 'user_id' not in session:\n                return jsonify({'status': 'error', 'message': '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'}), 401\n            \n            try:\n                farms = asyncio.run(self.get_user_farms(session['user_id']))\n                return jsonify({\n                    'status': 'success',\n                    'farms': farms\n                })\n            except Exception as e:\n                logger.error(f\"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–µ—Ä–º: {e}\")\n                return jsonify({\n                    'status': 'error',\n                    'message': str(e)\n                }), 500\n        \n        @self.app.route('/api/farm/<farm_ip>/data/current')\n        def api_get_farm_current_data(farm_ip):\n            \"\"\"–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö —Ñ–µ—Ä–º—ã\"\"\"\n            if 'user_id' not in session:\n                return jsonify({'status': 'error', 'message': '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'}), 401\n            \n            try:\n                data = asyncio.run(self.farm_connector.get_farm_current_data(farm_ip))\n                return jsonify(data)\n            except Exception as e:\n                logger.error(f\"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ñ–µ—Ä–º—ã {farm_ip}: {e}\")\n                return jsonify({\n                    'status': 'error',\n                    'message': str(e)\n                }), 500\n        \n        @self.app.route('/api/farm/<farm_ip>/data/history')\n        def api_get_farm_history(farm_ip):\n            \"\"\"–ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö —Ñ–µ—Ä–º—ã\"\"\"\n            if 'user_id' not in session:\n                return jsonify({'status': 'error', 'message': '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'}), 401\n            \n            try:\n                hours = int(request.args.get('hours', 24))\n                data = asyncio.run(self.farm_connector.get_farm_history_data(farm_ip, hours))\n                return jsonify(data)\n            except Exception as e:\n                logger.error(f\"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Ñ–µ—Ä–º—ã {farm_ip}: {e}\")\n                return jsonify({\n                    'status': 'error',\n                    'message': str(e)\n                }), 500\n        \n        @self.app.route('/api/farm/<farm_ip>/statistics')\n        def api_get_farm_statistics(farm_ip):\n            \"\"\"–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ñ–µ—Ä–º—ã\"\"\"\n            if 'user_id' not in session:\n                return jsonify({'status': 'error', 'message': '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'}), 401\n            \n            try:\n                data = asyncio.run(self.farm_connector.get_farm_statistics(farm_ip))\n                return jsonify(data)\n            except Exception as e:\n                logger.error(f\"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ñ–µ—Ä–º—ã {farm_ip}: {e}\")\n                return jsonify({\n                    'status': 'error',\n                    'message': str(e)\n                }), 500\n        \n        @self.app.route('/api/farm/<farm_ip>/command', methods=['POST'])\n        def api_send_farm_command(farm_ip):\n            \"\"\"–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã —Ñ–µ—Ä–º–µ\"\"\"\n            if 'user_id' not in session:\n                return jsonify({'status': 'error', 'message': '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'}), 401\n            \n            try:\n                data = request.get_json()\n                command = data.get('command')\n                params = data.get('params', {})\n                \n                result = asyncio.run(self.farm_connector.send_farm_command(farm_ip, command, params))\n                return jsonify(result)\n            except Exception as e:\n                logger.error(f\"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã —Ñ–µ—Ä–º–µ {farm_ip}: {e}\")\n                return jsonify({\n                    'status': 'error',\n                    'message': str(e)\n                }), 500\n        \n        @self.app.route('/api/farm/<farm_ip>/test_connection')\n        def api_test_farm_connection(farm_ip):\n            \"\"\"–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Ñ–µ—Ä–º–æ–π\"\"\"\n            if 'user_id' not in session:\n                return jsonify({'status': 'error', 'message': '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'}), 401\n            \n            try:\n                is_connected = asyncio.run(self.farm_connector.test_farm_connection(farm_ip))\n                return jsonify({\n                    'status': 'success',\n                    'connected': is_connected,\n                    'farm_ip': farm_ip,\n                    'tested_at': time.time()\n                })\n            except Exception as e:\n                logger.error(f\"–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Ñ–µ—Ä–º–æ–π {farm_ip}: {e}\")\n                return jsonify({\n                    'status': 'error',\n                    'message': str(e)\n                }), 500\n    \n    async def get_user_farms(self, user_id: str) -> List[Dict[str, Any]]:\n        \"\"\"–ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–µ—Ä–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Discovery Service\"\"\"\n        try:\n            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à\n            current_time = time.time()\n            if (current_time - self.last_cache_update) < self.cache_expiry and user_id in self.farms_cache:\n                logger.debug(f\"–í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–µ—Ä–º—ã –∏–∑ –∫—ç—à–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}\")\n                return self.farms_cache[user_id]\n            \n            # –ó–∞–ø—Ä–æ—Å –∫ Discovery Service\n            async with aiohttp.ClientSession() as session:\n                url = f\"{self.discovery_url}/api/farms/{user_id}\"\n                async with session.get(url) as response:\n                    if response.status == 200:\n                        data = await response.json()\n                        farms = data.get('farms', [])\n                        \n                        # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Ñ–µ—Ä–º–∞–º–∏\n                        for farm in farms:\n                            farm_ip = farm.get('tailscale_ip')\n                            if farm_ip:\n                                is_connected = await self.farm_connector.test_farm_connection(farm_ip)\n                                farm['connection_status'] = 'connected' if is_connected else 'disconnected'\n                            else:\n                                farm['connection_status'] = 'no_ip'\n                        \n                        # –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à\n                        self.farms_cache[user_id] = farms\n                        self.last_cache_update = current_time\n                        \n                        logger.info(f\"–ü–æ–ª—É—á–µ–Ω–æ {len(farms)} —Ñ–µ—Ä–º –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}\")\n                        return farms\n                    else:\n                        error_text = await response.text()\n                        logger.error(f\"–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ Discovery Service: {error_text}\")\n                        return []\n        \n        except Exception as e:\n            logger.error(f\"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–µ—Ä–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}\")\n            return []\n    \n    def run(self, host: str = '0.0.0.0', port: int = 5000, debug: bool = False):\n        \"\"\"–ó–∞–ø—É—Å–∫ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è\"\"\"\n        logger.info(f\"–ó–∞–ø—É—Å–∫ Tailscale Mobile App –Ω–∞ {host}:{port}\")\n        self.app.run(host=host, port=port, debug=debug)\n\n# HTML —à–∞–±–ª–æ–Ω—ã\nTAILSCALE_MOBILE_INDEX_TEMPLATE = '''\n<!DOCTYPE html>\n<html lang=\"ru\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>–§–µ—Ä–º—ã –ö–£–ë-1063 - Tailscale</title>\n    <style>\n        body {\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            margin: 0;\n            padding: 20px;\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n            min-height: 100vh;\n            color: #333;\n        }\n        .container {\n            max-width: 1200px;\n            margin: 0 auto;\n        }\n        .header {\n            background: rgba(255,255,255,0.95);\n            padding: 20px;\n            border-radius: 15px;\n            box-shadow: 0 4px 15px rgba(0,0,0,0.1);\n            margin-bottom: 30px;\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n        }\n        .farm-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));\n            gap: 20px;\n        }\n        .farm-card {\n            background: rgba(255,255,255,0.95);\n            border-radius: 15px;\n            padding: 20px;\n            box-shadow: 0 4px 15px rgba(0,0,0,0.1);\n            transition: transform 0.3s ease;\n        }\n        .farm-card:hover {\n            transform: translateY(-5px);\n        }\n        .farm-status {\n            display: inline-block;\n            padding: 5px 10px;\n            border-radius: 20px;\n            font-size: 12px;\n            font-weight: bold;\n        }\n        .status-connected { background: #4CAF50; color: white; }\n        .status-disconnected { background: #f44336; color: white; }\n        .status-unknown { background: #ff9800; color: white; }\n        .data-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n            gap: 10px;\n            margin: 15px 0;\n        }\n        .data-item {\n            background: #f5f5f5;\n            padding: 10px;\n            border-radius: 8px;\n            text-align: center;\n        }\n        .data-value {\n            font-size: 20px;\n            font-weight: bold;\n            color: #2196F3;\n        }\n        .data-label {\n            font-size: 12px;\n            color: #666;\n            margin-top: 5px;\n        }\n        .btn {\n            background: #2196F3;\n            color: white;\n            border: none;\n            padding: 10px 20px;\n            border-radius: 8px;\n            cursor: pointer;\n            margin: 5px;\n            transition: background 0.3s;\n        }\n        .btn:hover {\n            background: #1976D2;\n        }\n        .btn-small {\n            padding: 5px 10px;\n            font-size: 12px;\n        }\n        .loading {\n            text-align: center;\n            padding: 40px;\n            color: #666;\n        }\n        .error-message {\n            background: #ffebee;\n            color: #c62828;\n            padding: 10px;\n            border-radius: 8px;\n            margin: 10px 0;\n        }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <div class=\"header\">\n            <h1>üè≠ –ú–æ–∏ —Ñ–µ—Ä–º—ã –ö–£–ë-1063</h1>\n            <div>\n                <span id=\"username\">–ó–∞–≥—Ä—É–∑–∫–∞...</span>\n                <button class=\"btn btn-small\" onclick=\"logout()\">–í—ã—Ö–æ–¥</button>\n            </div>\n        </div>\n        \n        <div id=\"farms-container\">\n            <div class=\"loading\">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–µ—Ä–º...</div>\n        </div>\n    </div>\n\n    <script>\n        let farms = [];\n        let updateInterval;\n\n        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–µ—Ä–º –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ\n        document.addEventListener('DOMContentLoaded', function() {\n            loadFarms();\n            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥\n            updateInterval = setInterval(loadFarms, 30000);\n        });\n\n        async function loadFarms() {\n            try {\n                const response = await fetch('/api/farms');\n                const data = await response.json();\n                \n                if (data.status === 'success') {\n                    farms = data.farms;\n                    renderFarms();\n                    \n                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ–µ—Ä–º—ã\n                    farms.forEach(farm => {\n                        if (farm.connection_status === 'connected') {\n                            loadFarmData(farm.tailscale_ip);\n                        }\n                    });\n                } else {\n                    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–µ—Ä–º: ' + data.message);\n                }\n            } catch (error) {\n                showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É: ' + error.message);\n            }\n        }\n\n        function renderFarms() {\n            const container = document.getElementById('farms-container');\n            \n            if (farms.length === 0) {\n                container.innerHTML = '<div class=\"loading\">–§–µ—Ä–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';\n                return;\n            }\n            \n            container.innerHTML = '<div class=\"farm-grid\">' + \n                farms.map(farm => `\n                    <div class=\"farm-card\" id=\"farm-${farm.tailscale_ip}\">\n                        <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;\">\n                            <h3>${farm.farm_name}</h3>\n                            <span class=\"farm-status status-${farm.connection_status}\">\n                                ${getStatusText(farm.connection_status)}\n                            </span>\n                        </div>\n                        \n                        <div class=\"farm-info\">\n                            <p><strong>IP:</strong> ${farm.tailscale_ip}</p>\n                            <p><strong>–•–æ—Å—Ç:</strong> ${farm.hostname}</p>\n                            <p><strong>–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</strong> ${(farm.capabilities || []).join(', ')}</p>\n                        </div>\n                        \n                        <div class=\"data-container\" id=\"data-${farm.tailscale_ip}\">\n                            ${farm.connection_status === 'connected' ? \n                                '<div class=\"loading\">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>' : \n                                '<div class=\"error-message\">–§–µ—Ä–º–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</div>'\n                            }\n                        </div>\n                        \n                        <div class=\"farm-actions\">\n                            <button class=\"btn btn-small\" onclick=\"testConnection('${farm.tailscale_ip}')\">–¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</button>\n                            <button class=\"btn btn-small\" onclick=\"loadFarmData('${farm.tailscale_ip}')\">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>\n                            <button class=\"btn btn-small\" onclick=\"showFarmHistory('${farm.tailscale_ip}')\">–ò—Å—Ç–æ—Ä–∏—è</button>\n                        </div>\n                    </div>\n                `).join('') + \n            '</div>';\n        }\n\n        async function loadFarmData(farmIp) {\n            try {\n                const response = await fetch(`/api/farm/${farmIp}/data/current`);\n                const result = await response.json();\n                \n                const container = document.getElementById(`data-${farmIp}`);\n                \n                if (result._connection_status === 'success' && result.data) {\n                    const data = result.data;\n                    container.innerHTML = `\n                        <div class=\"data-grid\">\n                            <div class=\"data-item\">\n                                <div class=\"data-value\">${data.temperature_inside?.toFixed(1) || 'N/A'}¬∞C</div>\n                                <div class=\"data-label\">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</div>\n                            </div>\n                            <div class=\"data-item\">\n                                <div class=\"data-value\">${data.humidity?.toFixed(1) || 'N/A'}%</div>\n                                <div class=\"data-label\">–í–ª–∞–∂–Ω–æ—Å—Ç—å</div>\n                            </div>\n                            <div class=\"data-item\">\n                                <div class=\"data-value\">${data.co2_level || 'N/A'}</div>\n                                <div class=\"data-label\">CO‚ÇÇ ppm</div>\n                            </div>\n                            <div class=\"data-item\">\n                                <div class=\"data-value\">${data.ph_level?.toFixed(1) || 'N/A'}</div>\n                                <div class=\"data-label\">pH</div>\n                            </div>\n                        </div>\n                        <div style=\"text-align: center; margin-top: 10px; font-size: 12px; color: #666;\">\n                            –û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(data.timestamp * 1000).toLocaleTimeString()}\n                        </div>\n                    `;\n                } else {\n                    container.innerHTML = '<div class=\"error-message\">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + \n                        (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞') + '</div>';\n                }\n            } catch (error) {\n                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ñ–µ—Ä–º—ã:', error);\n                const container = document.getElementById(`data-${farmIp}`);\n                container.innerHTML = '<div class=\"error-message\">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>';\n            }\n        }\n\n        async function testConnection(farmIp) {\n            try {\n                const response = await fetch(`/api/farm/${farmIp}/test_connection`);\n                const result = await response.json();\n                \n                if (result.status === 'success') {\n                    alert(`–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Ñ–µ—Ä–º–æ–π ${farmIp}: ${result.connected ? '–£–°–ü–ï–®–ù–û' : '–ù–ï –£–î–ê–õ–û–°–¨'}`);\n                } else {\n                    alert('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ' + result.message);\n                }\n            } catch (error) {\n                alert('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ' + error.message);\n            }\n        }\n\n        function showFarmHistory(farmIp) {\n            // –ü—Ä–æ—Å—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ\n            const url = `/api/farm/${farmIp}/data/history?hours=24`;\n            window.open(url, '_blank');\n        }\n\n        function getStatusText(status) {\n            switch(status) {\n                case 'connected': return '–ü–æ–¥–∫–ª—é—á–µ–Ω–∞';\n                case 'disconnected': return '–û—Ç–∫–ª—é—á–µ–Ω–∞';\n                case 'no_ip': return '–ù–µ—Ç IP';\n                default: return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';\n            }\n        }\n\n        function showError(message) {\n            const container = document.getElementById('farms-container');\n            container.innerHTML = `<div class=\"error-message\">${message}</div>`;\n        }\n\n        async function logout() {\n            try {\n                await fetch('/api/logout', { method: 'POST' });\n                window.location.href = '/login';\n            } catch (error) {\n                console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);\n                window.location.href = '/login';\n            }\n        }\n    </script>\n</body>\n</html>\n'''\n\nTAILSCALE_MOBILE_LOGIN_TEMPLATE = '''\n<!DOCTYPE html>\n<html lang=\"ru\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>–í—Ö–æ–¥ - –§–µ—Ä–º—ã –ö–£–ë-1063</title>\n    <style>\n        body {\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            margin: 0;\n            padding: 0;\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n            min-height: 100vh;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        }\n        .login-container {\n            background: white;\n            padding: 40px;\n            border-radius: 15px;\n            box-shadow: 0 10px 30px rgba(0,0,0,0.2);\n            width: 100%;\n            max-width: 400px;\n        }\n        .login-header {\n            text-align: center;\n            margin-bottom: 30px;\n        }\n        .form-group {\n            margin-bottom: 20px;\n        }\n        label {\n            display: block;\n            margin-bottom: 5px;\n            font-weight: 500;\n            color: #333;\n        }\n        input[type=\"text\"], input[type=\"password\"] {\n            width: 100%;\n            padding: 12px;\n            border: 1px solid #ddd;\n            border-radius: 8px;\n            font-size: 16px;\n            box-sizing: border-box;\n        }\n        input[type=\"text\"]:focus, input[type=\"password\"]:focus {\n            outline: none;\n            border-color: #2196F3;\n            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);\n        }\n        .btn {\n            width: 100%;\n            background: #2196F3;\n            color: white;\n            border: none;\n            padding: 12px;\n            border-radius: 8px;\n            font-size: 16px;\n            cursor: pointer;\n            transition: background 0.3s;\n        }\n        .btn:hover {\n            background: #1976D2;\n        }\n        .btn:disabled {\n            background: #ccc;\n            cursor: not-allowed;\n        }\n        .error-message {\n            background: #ffebee;\n            color: #c62828;\n            padding: 10px;\n            border-radius: 8px;\n            margin-bottom: 20px;\n        }\n        .info-text {\n            text-align: center;\n            margin-top: 20px;\n            color: #666;\n            font-size: 14px;\n        }\n    </style>\n</head>\n<body>\n    <div class=\"login-container\">\n        <div class=\"login-header\">\n            <h2>üè≠ –§–µ—Ä–º—ã –ö–£–ë-1063</h2>\n            <p>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</p>\n        </div>\n        \n        <div id=\"error-message\" style=\"display: none;\"></div>\n        \n        <form id=\"login-form\">\n            <div class=\"form-group\">\n                <label for=\"username\">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>\n                <input type=\"text\" id=\"username\" name=\"username\" required>\n            </div>\n            \n            <div class=\"form-group\">\n                <label for=\"password\">–ü–∞—Ä–æ–ª—å:</label>\n                <input type=\"password\" id=\"password\" name=\"password\" required>\n            </div>\n            \n            <button type=\"submit\" class=\"btn\" id=\"login-btn\">–í–æ–π—Ç–∏</button>\n        </form>\n        \n        <div class=\"info-text\">\n            <p>–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ Tailscale mesh-—Å–µ—Ç—å</p>\n            <p><small>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Tailscale –∞–≥–µ–Ω—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∞–∫—Ç–∏–≤–µ–Ω</small></p>\n        </div>\n    </div>\n\n    <script>\n        document.getElementById('login-form').addEventListener('submit', async function(e) {\n            e.preventDefault();\n            \n            const username = document.getElementById('username').value;\n            const password = document.getElementById('password').value;\n            const loginBtn = document.getElementById('login-btn');\n            const errorDiv = document.getElementById('error-message');\n            \n            // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É\n            loginBtn.disabled = true;\n            loginBtn.textContent = '–í—Ö–æ–¥...';\n            errorDiv.style.display = 'none';\n            \n            try {\n                const response = await fetch('/api/login', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json'\n                    },\n                    body: JSON.stringify({ username, password })\n                });\n                \n                const result = await response.json();\n                \n                if (result.status === 'success') {\n                    window.location.href = '/';\n                } else {\n                    errorDiv.innerHTML = `<div class=\"error-message\">${result.message}</div>`;\n                    errorDiv.style.display = 'block';\n                }\n            } catch (error) {\n                errorDiv.innerHTML = `<div class=\"error-message\">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}</div>`;\n                errorDiv.style.display = 'block';\n            } finally {\n                loginBtn.disabled = false;\n                loginBtn.textContent = '–í–æ–π—Ç–∏';\n            }\n        });\n        \n        // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n        document.getElementById('username').focus();\n    </script>\n</body>\n</html>\n'''\n\n# –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ —à–∞–±–ª–æ–Ω–æ–≤\ndef create_templates():\n    \"\"\"–°–æ–∑–¥–∞–Ω–∏–µ HTML —à–∞–±–ª–æ–Ω–æ–≤\"\"\"\n    templates_dir = os.path.join(os.path.dirname(__file__), 'templates')\n    os.makedirs(templates_dir, exist_ok=True)\n    \n    with open(os.path.join(templates_dir, 'tailscale_mobile_index.html'), 'w', encoding='utf-8') as f:\n        f.write(TAILSCALE_MOBILE_INDEX_TEMPLATE)\n    \n    with open(os.path.join(templates_dir, 'tailscale_mobile_login.html'), 'w', encoding='utf-8') as f:\n        f.write(TAILSCALE_MOBILE_LOGIN_TEMPLATE)\n    \n    logger.info(f\"–°–æ–∑–¥–∞–Ω—ã HTML —à–∞–±–ª–æ–Ω—ã –≤ {templates_dir}\")\n\n# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è\nasync def main():\n    \"\"\"–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è\"\"\"\n    \n    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è\n    discovery_url = os.getenv('DISCOVERY_SERVICE_URL', 'http://localhost:8082')\n    tailscale_config = {\n        'tailnet': os.getenv('TAILNET', 'your-tailnet.ts.net'),\n        'api_key': os.getenv('TAILSCALE_API_KEY', 'tskey-api-xxx')\n    }\n    \n    # –°–æ–∑–¥–∞–µ–º —à–∞–±–ª–æ–Ω—ã\n    create_templates()\n    \n    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ\n    app = TailscaleMobileApp(discovery_url, tailscale_config)\n    \n    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä\n    logger.info(\"–ó–∞–ø—É—Å–∫ Tailscale Mobile App...\")\n    app.run(host='0.0.0.0', port=5000, debug=False)\n\nif __name__ == \"__main__\":\n    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è\n    logging.basicConfig(\n        level=logging.INFO,\n        format='%(asctime)s [%(name)s] %(levelname)s - %(message)s'\n    )\n    \n    # –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è\n    asyncio.run(main())"